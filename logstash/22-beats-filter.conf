filter{
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:logdate} %{USERNAME:level} - %{USERNAME:class}::%{GREEDYDATA:comment}"}
  }
  grok {
    match => { 
      "[log][file][path]" => "\/%{GREEDYDATA}\/%{GREEDYDATA}\/%{GREEDYDATA:filename}\.log"
    }
  }
  ruby {
    code => "
        fieldArray = event.get('message').scan(/[A-Za-z_]+=[^\s]+/)
        for field in fieldArray
            result = field.split('=')
            if result[1] =~ /^[0-9\.]+$/
                event.set(result[0], result[1].to_f)
            else
                event.set(result[0], result[1])
            end
        end
    "
  }
  if [EVENT] == 'PLAY_START' {
    aggregate {
      task_id => "%{TASK}"
      code => "map['duration'] = event.get('logdate')"
      map_action => "create"
    }
  }

  if [EVENT] == 'FIRST_RENDER' {
    aggregate {
      task_id => "%{TASK}"
      code => "event.set('duration', map['duration'])"
      end_of_task =>  true
      timeout => 120
    }
  }

  mutate {
    remove_field => ["host"] 
  }
  date {
    match => [ "logdate", "YYYY-MM-dd HH:mm:ss,SSS"]
    target => "logdate"
  }
}
